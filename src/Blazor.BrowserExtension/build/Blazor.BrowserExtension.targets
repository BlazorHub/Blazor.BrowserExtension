<!-- build/Blazor.BrowserExtension.targets -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <BrowserExtensionAssetsContentsPath>$(MSBuildThisFileDirectory)..\content\BrowserExtensionScripts</BrowserExtensionAssetsContentsPath>
    <BrowserExtensionAssetsTargetPath>$(BrowserExtensionAssetsPath)\BrowserExtensionScripts</BrowserExtensionAssetsTargetPath>
  </PropertyGroup>

  <!-- this will add the files to be copied to the output directory during build -->
  <ItemGroup Condition="'$(IncludeBrowserExtensionAssets)' == 'true'">
    <None Include="$(BrowserExtensionAssetsContentsPath)\**\*.*" Link="$(BrowserExtensionAssetsTargetPath)\%(RecursiveDir)%(Filename)%(Extension)">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <!-- this will automatically run before the 'RunBuildBlazorToBrowserExtension' target defined in Blazor.BrowserExtension.Build package -->
  <Target Name="RunTokenReplacementToBrowserExtension" BeforeTargets="RunBuildBlazorToBrowserExtension" Condition="'$(BuildBlazorToBrowserExtension)' == 'true'">

    <PropertyGroup>
      <BrowserExtensionAssetsOutputPath>$(TargetDir)$(BrowserExtensionAssetsPath)\BrowserExtensionScripts</BrowserExtensionAssetsOutputPath>
    </PropertyGroup>

    <Message Importance="high" Text="Replacing content of core Blazor.BrowserExtension *.js files" />
    <ItemGroup>
      <BrowserExtensionAssetsOutputJsFiles Include="$(BrowserExtensionAssetsOutputPath)\*.js" />
    </ItemGroup>
    <BlazorToBrowserExtensionSafeNamespace Input="$(ProjectName)" Replacement="_">
      <Output TaskParameter="Output" PropertyName="BlazorProjectSafeProjectName" />
    </BlazorToBrowserExtensionSafeNamespace>
    <ItemGroup>
      <BrowserExtensionReplaceAssetsOutputJsFilesContents Include="Safe project name">
        <From>__ProjectName__</From>
        <To>$(BlazorProjectSafeProjectName)</To>
      </BrowserExtensionReplaceAssetsOutputJsFilesContents>
      <BrowserExtensionReplaceAssetsOutputJsFilesContents Include="Environment name">
        <From>__EnvironmentName__</From>
        <To>$(BrowserExtensionEnvironment)</To>
      </BrowserExtensionReplaceAssetsOutputJsFilesContents>
      <BrowserExtensionReplaceAssetsOutputJsFilesContents Include="Compression enabled">
        <From>__CompressionEnabled__</From>
        <To>false</To>
      </BrowserExtensionReplaceAssetsOutputJsFilesContents>
    </ItemGroup>
    <BlazorToBrowserExtensionReplaceContent Files="@(BrowserExtensionAssetsOutputJsFiles)" Replace="@(BrowserExtensionReplaceAssetsOutputJsFilesContents)" FailOnWarning="true" FailMessage="Clean the project before build" />

  </Target>

  <!-- this will automatically run after the 'RunPublishBlazorToBrowserExtension' target defined in Blazor.BrowserExtension.Build package -->
  <Target Name="RunTokenReplacementToPublishedBrowserExtension" AfterTargets="RunPublishBlazorToBrowserExtension" Condition="'$(PublishBlazorToBrowserExtension)' == 'true'">

    <PropertyGroup>
      <BrowserExtensionAssetsPublishPath>$(PublishDir)$(BrowserExtensionAssetsPath)\BrowserExtensionScripts</BrowserExtensionAssetsPublishPath>
    </PropertyGroup>

    <Message Importance="high" Text="Replacing content of core Blazor.BrowserExtension *.js files" />
    <ItemGroup>
      <BrowserExtensionAssetsPublishedJsFiles Include="$(BrowserExtensionAssetsPublishPath)\*.js" />
    </ItemGroup>
    <BlazorToBrowserExtensionSafeNamespace Input="$(ProjectName)" Replacement="_">
      <Output TaskParameter="Output" PropertyName="BlazorProjectSafeProjectName" />
    </BlazorToBrowserExtensionSafeNamespace>
    <ItemGroup>
      <BrowserExtensionReplaceAssetsPublishedJsFilesContents Include="Safe project name">
        <From>__ProjectName__</From>
        <To>$(BlazorProjectSafeProjectName)</To>
      </BrowserExtensionReplaceAssetsPublishedJsFilesContents>
      <BrowserExtensionReplaceAssetsPublishedJsFilesContents Include="Environment name">
        <From>__EnvironmentName__</From>
        <To>$(BrowserExtensionEnvironment)</To>
      </BrowserExtensionReplaceAssetsPublishedJsFilesContents>
      <BrowserExtensionReplaceAssetsPublishedJsFilesContents Include="Compression enabled">
        <From>__CompressionEnabled__</From>
        <To>$(BrowserExtensionEnableCompression)</To>
      </BrowserExtensionReplaceAssetsPublishedJsFilesContents>
    </ItemGroup>
    <BlazorToBrowserExtensionReplaceContent Files="@(BrowserExtensionAssetsPublishedJsFiles)" Replace="@(BrowserExtensionReplaceAssetsPublishedJsFilesContents)" FailOnWarning="true" FailMessage="Clean the project before build" />

  </Target>

</Project>