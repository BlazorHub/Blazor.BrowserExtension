<!-- build/Blazor.BrowserExtension.targets -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Region
    Adds the content JavaScript files from the NuGet package to the project.
    Link is used to allow the files to be copied from the package to the project build and publish output before their contents are replaced.
  -->
  <PropertyGroup>
    <_BrowserExtension_Package_Contents_Scripts_Directory Condition="'$(_BrowserExtension_Package_Contents_Scripts_Directory)' == ''">$(MSBuildThisFileDirectory)..\content\BrowserExtensionScripts</_BrowserExtension_Package_Contents_Scripts_Directory>
    <_BrowserExtension_Project_Link_Scripts_Directory>$(BrowserExtensionAssetsPath)\$(LinkBrowserExtensionAssetsPath)</_BrowserExtension_Project_Link_Scripts_Directory>
  </PropertyGroup>

  <ItemGroup Condition="'$(IncludeBrowserExtensionAssets)' == 'true'">
    <None Include="$(_BrowserExtension_Package_Contents_Scripts_Directory)\**\*.*"
          Link="$(_BrowserExtension_Project_Link_Scripts_Directory)\%(RecursiveDir)%(Filename)%(Extension)">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <Target Name="AddComputedBrowserExtensionScriptsStaticWebAssets"
          BeforeTargets="GenerateStaticWebAssetsManifest">
    <ItemGroup Condition="'$(IncludeBrowserExtensionAssets)' == 'true'">
      <_BrowserExtension_Package_Contents_Scripts_Files Include="$(_BrowserExtension_Package_Contents_Scripts_Directory)\**\*.*" />
      <StaticWebAsset Include="@(_BrowserExtension_Package_Contents_Scripts_Files)">
        <SourceType>Computed</SourceType>
        <SourceId>Blazor.BrowserExtension</SourceId>
        <ContentRoot>$(TargetDir)$(BrowserExtensionAssetsPath)</ContentRoot>
        <BasePath>/</BasePath>
        <RelativePath>$(LinkBrowserExtensionAssetsPath)/%(RecursiveDir)%(Filename)%(Extension)</RelativePath>
        <OriginalItemSpec>%(FullPath)</OriginalItemSpec>
        <AssetKind>All</AssetKind>
        <AssetMode>All</AssetMode>
        <AssetRole>Primary</AssetRole>
        <CopyToOutputDirectory>Never</CopyToOutputDirectory>
        <CopyToPublishDirectory>Never</CopyToPublishDirectory>
      </StaticWebAsset>
    </ItemGroup>
  </Target>
  <!-- EndRegion -->

  <!-- Target
    Runs only when another target depends on this target.
    Defines the config for browser extension.
  -->
  <Target Name="DefineBlazorToBrowserExtensionConfig">

    <BlazorToBrowserExtensionSafeNamespace Input="$(ProjectName)" Replacement="_">
      <Output TaskParameter="Output" PropertyName="_BrowserExtension_Project_SafeProjectName" />
    </BlazorToBrowserExtensionSafeNamespace>

    <ItemGroup>
      <BrowserExtensionConfig Include="Safe project name">
        <Key>ProjectName</Key>
        <Value>$(_BrowserExtension_Project_SafeProjectName)</Value>
      </BrowserExtensionConfig>
      <BrowserExtensionConfig Include="Environment name">
        <Key>EnvironmentName</Key>
        <Value>$(BrowserExtensionEnvironment)</Value>
      </BrowserExtensionConfig>
      <BrowserExtensionConfig Include="Compression enabled">
        <Key>CompressionEnabled</Key>
        <Value>$(BrowserExtensionEnableCompression)</Value>
        <Type>bool</Type>
      </BrowserExtensionConfig>
    </ItemGroup>

  </Target>

  <!-- Target
    Runs before the build happens.
    Writes the configuration file in the intermediate directory and add as StaticWebAsset.
  -->
  <Target Name="WriteBlazorToBrowserExtensionBuildConfigFile"
          BeforeTargets="BeforeBuild"
          Condition="'$(IncludeBrowserExtensionAssets)' == 'true' and '$(BuildBlazorToBrowserExtension)' == 'true'"
          DependsOnTargets="DefineBlazorToBrowserExtensionConfig">

    <PropertyGroup>
      <_BrowserExtension_Project_IntermediateOutput_ConfigFile_Directory>$(ProjectDir)$(IntermediateOutputPath)browserextension\build</_BrowserExtension_Project_IntermediateOutput_ConfigFile_Directory>
      <_BrowserExtension_Project_IntermediateOutput_ConfigFile_FilePath>$(_BrowserExtension_Project_IntermediateOutput_ConfigFile_Directory)\browserextension.config.json</_BrowserExtension_Project_IntermediateOutput_ConfigFile_FilePath>
    </PropertyGroup>

    <ItemGroup>
      <!-- Force disable compression when build -->
      <BrowserExtensionConfig Condition="'%(BrowserExtensionConfig.Key)' == 'CompressionEnabled'">
        <Value>false</Value>
      </BrowserExtensionConfig>
    </ItemGroup>

    <Message Importance="high" Text="Creating configuration file '$(_BrowserExtension_Project_IntermediateOutput_ConfigFile_FilePath)'" />
    <BlazorToBrowserExtensionWriteConfigFile Input="@(BrowserExtensionConfig)"
                                             FilePath="$(_BrowserExtension_Project_IntermediateOutput_ConfigFile_FilePath)" />

    <ItemGroup>
      <StaticWebAsset Include="$(_BrowserExtension_Project_IntermediateOutput_ConfigFile_FilePath)">
        <SourceType>Computed</SourceType>
        <SourceId>Blazor.BrowserExtension</SourceId>
        <ContentRoot>$(_BrowserExtension_Project_IntermediateOutput_ConfigFile_Directory)</ContentRoot>
        <BasePath>_content</BasePath>
        <RelativePath>_content/browserextension.config.json</RelativePath>
        <OriginalItemSpec>$(_BrowserExtension_Project_IntermediateOutput_ConfigFile_FilePath)</OriginalItemSpec>
        <AssetKind>All</AssetKind>
        <AssetMode>All</AssetMode>
        <AssetRole>Primary</AssetRole>
        <CopyToOutputDirectory>Never</CopyToOutputDirectory>
        <CopyToPublishDirectory>Never</CopyToPublishDirectory>
      </StaticWebAsset>
    </ItemGroup>

  </Target>

  <!-- Target
    Runs before the publish happens.
    Writes the configuration file in the intermediate directory and add as ResolvedFileToPublish.
  -->
  <Target Name="WriteBlazorToBrowserExtensionPublishConfigFile"
          BeforeTargets="BeforePublish"
          Condition="'$(IncludeBrowserExtensionAssets)' == 'true' and '$(BuildBlazorToBrowserExtension)' == 'true'"
          DependsOnTargets="DefineBlazorToBrowserExtensionConfig">

    <PropertyGroup>
      <_BrowserExtension_Project_IntermediateOutput_ConfigFile_Directory>$(ProjectDir)$(IntermediateOutputPath)browserextension\publish</_BrowserExtension_Project_IntermediateOutput_ConfigFile_Directory>
      <_BrowserExtension_Project_IntermediateOutput_ConfigFile_FilePath>$(_BrowserExtension_Project_IntermediateOutput_ConfigFile_Directory)\browserextension.config.json</_BrowserExtension_Project_IntermediateOutput_ConfigFile_FilePath>
    </PropertyGroup>

    <ItemGroup>
      <!-- Force disable compression when build -->
      <BrowserExtensionConfig Condition="'%(BrowserExtensionConfig.Key)' == 'CompressionEnabled'">
        <Value>$(BrowserExtensionEnableCompression)</Value>
      </BrowserExtensionConfig>
    </ItemGroup>

    <Message Importance="high" Text="Creating configuration file '$(_BrowserExtension_Project_IntermediateOutput_ConfigFile_FilePath)'" />
    <BlazorToBrowserExtensionWriteConfigFile Input="@(BrowserExtensionConfig)"
                                             FilePath="$(_BrowserExtension_Project_IntermediateOutput_ConfigFile_FilePath)" />

    <ItemGroup>
      <ResolvedFileToPublish Include="$(_BrowserExtension_Project_IntermediateOutput_ConfigFile_FilePath)"
                             ExcludeFromSingleFile="true"
                             CopyToPublishDirectory="Always"
                             RelativePath="$(BrowserExtensionAssetsPath)\_content\browserextension.config.json" />
    </ItemGroup>

  </Target>

</Project>