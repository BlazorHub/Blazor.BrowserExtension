<!-- build/Blazor.BrowserExtension.targets -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Region
    Adds the content JavaScript files from the NuGet package to the project
  -->
  <PropertyGroup>
    <_BrowserExtension_Package_Contents_Scripts_Directory Condition="'$(_BrowserExtension_Package_Contents_Scripts_Directory)' == ''">$(MSBuildThisFileDirectory)..\content\BrowserExtensionScripts</_BrowserExtension_Package_Contents_Scripts_Directory>
    <_BrowserExtension_Project_Link_Scripts_Directory>$(BrowserExtensionAssetsPath)\$(LinkBrowserExtensionAssetsPath)</_BrowserExtension_Project_Link_Scripts_Directory>
  </PropertyGroup>

  <ItemGroup Condition="'$(IncludeBrowserExtensionAssets)' == 'true'">
    <None Include="$(_BrowserExtension_Package_Contents_Scripts_Directory)\**\*.*"
          Link="$(_BrowserExtension_Project_Link_Scripts_Directory)\%(RecursiveDir)%(Filename)%(Extension)">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </None>
  </ItemGroup>
  <!-- EndRegion -->

  <!-- Target
    Runs only when another target depends on this target.
    Defines the properties required for replacing Core.js and ContentScript.js.
  -->
  <Target Name="DefineBlazorToBrowserExtensionScriptsJsFileContentReplacements">

    <BlazorToBrowserExtensionSafeNamespace Input="$(ProjectName)" Replacement="_">
      <Output TaskParameter="Output" PropertyName="_BrowserExtension_Project_SafeProjectName" />
    </BlazorToBrowserExtensionSafeNamespace>
    
    <ItemGroup>
      <_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements Include="Safe project name">
        <From>__ProjectName__</From>
        <To>$(_BrowserExtension_Project_SafeProjectName)</To>
      </_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements>
      <_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements Include="Environment name">
        <From>__EnvironmentName__</From>
        <To>$(BrowserExtensionEnvironment)</To>
      </_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements>
      <_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements Include="Compression enabled">
        <From>__CompressionEnabled__</From>
        <To>$(BrowserExtensionEnableCompression)</To>
      </_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements>
    </ItemGroup>

  </Target>

  <!-- Target
    Runs after the 'RunBuildBlazorToBrowserExtension' target defined in Blazor.BrowserExtension.Build package.
    Replaces the tokens in the JavaScript files in the build output directory.
  -->
  <Target Name="RunTokenReplacementToBuildOutputBrowserExtensionScripts"
          AfterTargets="RunBuildBlazorToBrowserExtension"
          Condition="'$(IncludeBrowserExtensionAssets)' == 'true' and '$(BuildBlazorToBrowserExtension)' == 'true'"
          DependsOnTargets="DefineBlazorToBrowserExtensionScriptsJsFileContentReplacements">

    <PropertyGroup>
      <_BrowserExtension_Project_BuildOutput_Scripts_Directory>$(TargetDir)$(BrowserExtensionOutputPath)\$(LinkBrowserExtensionAssetsPath)</_BrowserExtension_Project_BuildOutput_Scripts_Directory>
    </PropertyGroup>
    <ItemGroup>
      <_BrowserExtension_Project_BuildOutput_Scripts_JsFiles Include="$(_BrowserExtension_Project_BuildOutput_Scripts_Directory)\Core.js" />
      <_BrowserExtension_Project_BuildOutput_Scripts_JsFiles Include="$(_BrowserExtension_Project_BuildOutput_Scripts_Directory)\ContentScript.js" />
      <_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements Condition="'%(_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements.From)' == '__CompressionEnabled__'">
        <To>false</To>
      </_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements>
    </ItemGroup>

    <Message Importance="high" Text="Replacing content of core Blazor.BrowserExtension Core.js and ContentScript.js" />
    <BlazorToBrowserExtensionReplaceContent Files="@(_BrowserExtension_Project_BuildOutput_Scripts_JsFiles)"
                                            Replace="@(_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements)"
                                            FailOnWarning="true"
                                            FailMessage="Clean the project before build" />

  </Target>
  
  <!-- Target
    Runs after the 'RunPublishBlazorToBrowserExtension' target defined in Blazor.BrowserExtension.Build package.
    Replaces the tokens in the JavaScript files in the publish output directory.
  -->
  <Target Name="RunTokenReplacementToPublishOutputBrowserExtensionScripts"
          AfterTargets="RunPublishBlazorToBrowserExtension"
          Condition="'$(IncludeBrowserExtensionAssets)' == 'true' and '$(PublishBlazorToBrowserExtension)' == 'true'"
          DependsOnTargets="DefineBlazorToBrowserExtensionScriptsJsFileContentReplacements">

    <PropertyGroup>
      <_BrowserExtension_Project_PublishOutput_Scripts_Directory>$(PublishDir)$(BrowserExtensionOutputPath)\$(LinkBrowserExtensionAssetsPath)</_BrowserExtension_Project_PublishOutput_Scripts_Directory>
    </PropertyGroup>
    <ItemGroup>
      <_BrowserExtension_Project_PublishOutput_Scripts_JsFiles Include="$(_BrowserExtension_Project_PublishOutput_Scripts_Directory)\Core.js" />
      <_BrowserExtension_Project_PublishOutput_Scripts_JsFiles Include="$(_BrowserExtension_Project_PublishOutput_Scripts_Directory)\ContentScript.js" />
      <_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements Condition="'%(_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements.From)' == '__CompressionEnabled__'">
        <To>$(BrowserExtensionEnableCompression)</To>
      </_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements>
    </ItemGroup>

    <Message Importance="high" Text="Replacing content of core Blazor.BrowserExtension Core.js and ContentScript.js" />
    <BlazorToBrowserExtensionReplaceContent Files="@(_BrowserExtension_Project_PublishOutput_Scripts_JsFiles)"
                                            Replace="@(_BrowserExtension_BrowserExtensionScriptsJs_FileContentReplacements)"
                                            FailOnWarning="true"
                                            FailMessage="Clean the project before publish" />

  </Target>

</Project>